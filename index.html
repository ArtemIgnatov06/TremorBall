<!DOCTYPE html>
<html>
<head>
    <title>TremorBall Online</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { margin: 0; background: #222; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; }
        canvas { border: 4px solid #fff; box-shadow: 0 0 20px rgba(255,255,255,0.2); }
    </style>
</head>
<body>
<script>
    const socket = io();
    const { Engine, Render, Runner, Bodies, Composite, Body, Vector } = Matter;

    const engine = Engine.create();
    const render = Render.create({
        element: document.body,
        engine: engine,
        options: { width: 800, height: 600, wireframes: false, background: '#87CEEB' }
    });

    // Create Game Objects
    const ground = Bodies.rectangle(400, 590, 810, 60, { isStatic: true, render: { fillStyle: '#edc9af' } });
    const net = Bodies.rectangle(400, 450, 10, 200, { isStatic: true, render: { fillStyle: '#fff' } });
    const ball = Bodies.circle(400, 100, 20, { 
        restitution: 1, friction: 0.005, render: { fillStyle: '#ff5722' } 
    });

    const myPlayer = Bodies.circle(100, 500, 30, { friction: 0.1, render: { fillStyle: '#2ecc71' } });
    const opponent = Bodies.circle(700, 500, 30, { isStatic: true, render: { fillStyle: '#e74c3c' } });

    Composite.add(engine.world, [ground, net, ball, myPlayer, opponent]);

    // Controls
    const keys = {};
    window.onkeydown = (e) => keys[e.code] = true;
    window.onkeyup = (e) => keys[e.code] = false;

    // Game Loop
    Matter.Events.on(engine, 'afterUpdate', () => {
        let speed = 5;
        if (keys['ArrowLeft']) Body.setVelocity(myPlayer, { x: -speed, y: myPlayer.velocity.y });
        if (keys['ArrowRight']) Body.setVelocity(myPlayer, { x: speed, y: myPlayer.velocity.y });
        if (keys['ArrowUp'] && Math.abs(myPlayer.velocity.y) < 0.1) Body.setVelocity(myPlayer, { x: myPlayer.velocity.x, y: -10 });

        socket.emit('move', { x: myPlayer.position.x, y: myPlayer.position.y });
        
        // Only the "owner" of the ball (closest player) syncs its position to prevent lag fights
        if (Vector.magnitude(Vector.sub(myPlayer.position, ball.position)) < 100) {
            socket.emit('ballSync', { x: ball.position.x, y: ball.position.y, vx: ball.velocity.x, vy: ball.velocity.y });
        }
    });

    socket.on('update', (data) => {
        Body.setPosition(opponent, { x: data.x, y: data.y });
    });

    socket.on('ballUpdate', (data) => {
        Body.setPosition(ball, { x: data.x, y: data.y });
        Body.setVelocity(ball, { x: data.vx, y: data.vy });
    });

    Render.run(render);
    Runner.run(Runner.create(), engine);
</script>
</body>
</html>